<!DOCTYPE html>
<html><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="https://lajunta.github.io/hugoblog/css/tailwind.min.min.457dc15ac9728ea8ce51b6ee57135c381611688c4abea2ae8ffded28e7a37daf.css">
  
  <link rel="stylesheet" href="https://lajunta.github.io/hugoblog/css/style.min.c0ad41ced7523ea8a0f933c901c8da089bf513df82f78df868dfee4406c85f57.css">
  <title>Document</title>
</head><body><header class="bg-white mb-3">
  <div class="container mx-auto px-10">
    <nav class="flex h-20 items-center justify-between">
      <a href=https://lajunta.github.io/hugoblog/ class="text-4xl">文章中心</a>

      <div>
        
        <a href="/hugoblog/categories/" class="ml-5">目录</a>
        
        <a href="/hugoblog/tags/" class="ml-5">标签</a>
        
      </div>
    </nav>
  </div>
</header><div class="container mx-auto p-10 bg-white ">
<div class="text-2xl text-gray-700 mb-4">Mongodb Backup and restore</div>
<div class="mb-3 text-xs">
  <span datetime=" 2021-04-06 08:04" class="text-gray-300">2021-04-06 08:04</span>
  <span class="mr-4 text-gray-300 italic"> <a href=/database/mongodb/>database/mongodb/</a></span>
</div>
<hr>
<h1 id="mongodb-database-dump-restore">Mongodb Database dump restore</h1>
<h3 id="导出为-csv-格式">导出为 csv 格式</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">mongoexport --db myinfo --collection userdetails --csv --fields user_id,education,interest --out /opt/backups/userdetails.csv
</code></pre></td></tr></table>
</div>
</div><h3 id="按条件导出">按条件导出</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">mongoexport --db myinfo --collection userdetails --query &#34;{&#39;interest&#39; : &#39;MUSIC&#39;}&#34;
</code></pre></td></tr></table>
</div>
</div><h3 id="从csv-导入">从csv 导入</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">mongoimport --db myinfo --collection userdetails --type csv --headerline --file /backup_data/backup/userdetails.csv
</code></pre></td></tr></table>
</div>
</div><h3 id="单数据库备份">单数据库备份</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#ff79c6">#!/usr/bin/zsh
</span><span style="color:#ff79c6"></span>
<span style="color:#8be9fd;font-style:italic">BACKUP_DIR</span><span style="color:#ff79c6">=</span>/data/mongobackup
<span style="color:#8be9fd;font-style:italic">DAILY_DIR</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$BACKUP_DIR</span>/DAILY
<span style="color:#8be9fd;font-style:italic">WEEKLY_DIR</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$BACKUP_DIR</span>/WEEKLY
<span style="color:#8be9fd;font-style:italic">MONTHLY_DIR</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$BACKUP_DIR</span>/MONTHLY

<span style="color:#8be9fd;font-style:italic">DB_NAME</span><span style="color:#ff79c6">=</span>lwqbg_production
<span style="color:#8be9fd;font-style:italic">DAILYFILE</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>date +%u<span style="color:#ff79c6">)</span>_<span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">DB_NAME</span><span style="color:#f1fa8c">}</span>.tar
<span style="color:#8be9fd;font-style:italic">WEEKLYFILE</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>date +%U<span style="color:#ff79c6">)</span>_<span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">DB_NAME</span><span style="color:#f1fa8c">}</span>.tar
<span style="color:#8be9fd;font-style:italic">MONTHLYFILE</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>date +%m<span style="color:#ff79c6">)</span>_<span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">DB_NAME</span><span style="color:#f1fa8c">}</span>.tar

<span style="color:#ff79c6">function</span> make_dir<span style="color:#ff79c6">(){</span>
  <span style="color:#8be9fd;font-style:italic">ary</span><span style="color:#ff79c6">=(</span><span style="color:#8be9fd;font-style:italic">$DAILY_DIR</span> <span style="color:#8be9fd;font-style:italic">$WEEKLY_DIR</span> <span style="color:#8be9fd;font-style:italic">$MONTHLY_DIR</span><span style="color:#ff79c6">)</span>
  <span style="color:#ff79c6">for</span> dir in <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">ary</span>[@]<span style="color:#f1fa8c">}</span>; <span style="color:#ff79c6">do</span>
    mkdir -p <span style="color:#8be9fd;font-style:italic">$dir</span>
  <span style="color:#ff79c6">done</span>
<span style="color:#ff79c6">}</span>

<span style="color:#ff79c6">function</span> onedb_backup<span style="color:#ff79c6">(){</span>
  <span style="color:#8be9fd;font-style:italic">tmpfile</span><span style="color:#ff79c6">=</span>/tmp/<span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">DB_NAME</span><span style="color:#f1fa8c">}</span>_backup.tar
  mongodump -d <span style="color:#8be9fd;font-style:italic">$DB_NAME</span> --quiet --gzip --archive<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$tmpfile</span>
  cp <span style="color:#8be9fd;font-style:italic">$tmpfile</span> <span style="color:#8be9fd;font-style:italic">$DAILY_DIR</span>/<span style="color:#8be9fd;font-style:italic">$DAILYFILE</span>

  <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">[</span> ! -e <span style="color:#8be9fd;font-style:italic">$WEEKLY_DIR</span>/<span style="color:#8be9fd;font-style:italic">$WEEKLYFILE</span> <span style="color:#ff79c6">]</span>;<span style="color:#ff79c6">then</span>
    <span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;Creating Weekly File&#34;</span> 
    cp <span style="color:#8be9fd;font-style:italic">$tmpfile</span> <span style="color:#8be9fd;font-style:italic">$WEEKLY_DIR</span>/<span style="color:#8be9fd;font-style:italic">$WEEKLYFILE</span>
  <span style="color:#ff79c6">fi</span>  

  <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">[</span> ! -e <span style="color:#8be9fd;font-style:italic">$MONTHLY_DIR</span>/<span style="color:#8be9fd;font-style:italic">$MONTHLYFILE</span> <span style="color:#ff79c6">]</span>;<span style="color:#ff79c6">then</span>
    <span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;Creating Monthly File&#34;</span> 
    cp <span style="color:#8be9fd;font-style:italic">$tmpfile</span> <span style="color:#8be9fd;font-style:italic">$MONTHLY_DIR</span>/<span style="color:#8be9fd;font-style:italic">$MONTHLYFILE</span>
  <span style="color:#ff79c6">fi</span>  
  rm <span style="color:#8be9fd;font-style:italic">$tmpfile</span>
  <span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;tmpfile removed&#34;</span>
<span style="color:#ff79c6">}</span>

make_dir
onedb_backup

</code></pre></td></tr></table>
</div>
</div><h3 id="数据库恢复">数据库恢复</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">mongorestore --quiet --gzip --archive=backupedfile

mongorestore -d different database --quiet --gzip --archive=backedfile 
</code></pre></td></tr></table>
</div>
</div><h3 id="重命名数据库">重命名数据库</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">mongodump --archive=&#34;mongodump-test-db&#34; --db=test

mongorestore --archive=&#34;mongodump-test-db&#34; --nsFrom=&#39;test.*&#39; --nsTo=&#39;examples.*&#39;
</code></pre></td></tr></table>
</div>
</div>

    </div></body>

</html>