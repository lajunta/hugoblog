<!DOCTYPE html>
<html><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="https://lajunta.vercel.app/css/tailwind.min.min.d9a9ae40100d24a1171de2958f7a2561352df9d0606cdb4d6ea39e37d79f150e.css">
  
  <link rel="stylesheet" href="https://lajunta.vercel.app/css/style.min.c0ad41ced7523ea8a0f933c901c8da089bf513df82f78df868dfee4406c85f57.css">
  <title>Document</title>
</head><body><header class="bg-white mb-3">
  <div class="container mx-auto px-10">
    <nav class="flex h-20 items-center justify-between">
      <a href=https://lajunta.vercel.app/ class="text-4xl">文章中心</a>

      <div>
        
        <a href="/categories/" class="ml-5">目录</a>
        
        <a href="/tags/" class="ml-5">标签</a>
        
      </div>
    </nav>
  </div>
</header><div class="container mx-auto p-10 bg-white ">
<div class="text-2xl text-gray-700 mb-4">Wireguard</div>
<div class="mb-3 text-xs">
  <span datetime=" 2021-06-07 08:34" class="text-gray-300">2021-06-07 08:34</span>
  <span class="mr-4 text-gray-300 italic"> <a href=/linux/sysadmin/>linux/sysadmin/</a></span>
</div>
<hr>
<h1 id="wireguard">wireguard</h1>
<h3 id="links">Links</h3>
<ol>
<li>
<p><a href="https://wiki.archlinux.org/title/WireGuard">Archlinux Wireguard Tutorial</a></p>
</li>
<li>
<p><a href="https://wiki.archlinux.org/title/WireGuard#Specific_use-case:_VPN_server">VPN Server</a></p>
</li>
</ol>
<h3 id="配置网络界面">配置网络界面</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ip link add dev wg0 <span style="color:#8be9fd;font-style:italic">type</span> wireguard
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>增加IP地址</li>
</ol>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ip address add dev wg0 192.168.88.1/24
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 如果只是二个电脑相联</span>
</span></span><span style="display:flex;"><span>ip address add dev wg0 192.168.88.1 peer 192.168.88.2
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>通过配置文件进行配置</li>
</ol>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  wg setconf wg0 myconfig.conf
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>激活界面</li>
</ol>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ip link <span style="color:#8be9fd;font-style:italic">set</span> up dev wg0
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="查看显示界面">查看显示界面</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  wg
</span></span><span style="display:flex;"><span>  wg show
</span></span><span style="display:flex;"><span>  wg showconf
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="生成钥匙">生成钥匙</h3>
<p>生成私钥</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">umask</span> <span style="color:#bd93f9">077</span>
</span></span><span style="display:flex;"><span>  wg genkey &gt; privatekey
</span></span></code></pre></td></tr></table>
</div>
</div><p>生成公钥</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  wg pubkey &lt; privatekey &gt; publickey
</span></span><span style="display:flex;"><span>  or
</span></span><span style="display:flex;"><span>  wg genkey | tee privatekey | wg pubkey &gt; publickey
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="vpn-server">VPN Server</h3>
<p>server config /etc/wireguard/wg0.conf</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff79c6">[</span>Interface<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">Address</span> <span style="color:#ff79c6">=</span> 10.200.200.1/24
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">ListenPort</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">51820</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">PrivateKey</span> <span style="color:#ff79c6">=</span> SERVER_PRIVATE_KEY
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># substitute eth0 in the following lines to match the Internet-facing interface</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># if the server is behind a router and receives traffic via NAT, these iptables rules are not needed</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">PostUp</span> <span style="color:#ff79c6">=</span> iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">PostDown</span> <span style="color:#ff79c6">=</span> iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>Peer<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># peer foo</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">PublicKey</span> <span style="color:#ff79c6">=</span> PEER_FOO_PUBLIC_KEY
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">PresharedKey</span> <span style="color:#ff79c6">=</span> PRE-SHARED_KEY
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">AllowedIPs</span> <span style="color:#ff79c6">=</span> 10.200.200.2/32
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>Peer<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># peer bar</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">PublicKey</span> <span style="color:#ff79c6">=</span> PEER_BAR_PUBLIC_KEY
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">PresharedKey</span> <span style="color:#ff79c6">=</span> PRE-SHARED_KEY
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">AllowedIPs</span> <span style="color:#ff79c6">=</span> 10.200.200.3/32
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>启动\停止server</strong></p>
<pre tabindex="0"><code>wg-quick up wg0
wg-quick down wg0
</code></pre><h3 id="vpn-client">VPN Client</h3>
<p>foo client</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff79c6">[</span>Interface<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">Address</span> <span style="color:#ff79c6">=</span> 10.200.200.2/32
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">MTU</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1420</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">PrivateKey</span> <span style="color:#ff79c6">=</span> PEER_FOO_PRIVATE_KEY
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">DNS</span> <span style="color:#ff79c6">=</span> 10.200.200.1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>Peer<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">PublicKey</span> <span style="color:#ff79c6">=</span> SERVER_PUBLICKEY
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">PresharedKey</span> <span style="color:#ff79c6">=</span> PRE-SHARED_KEY
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">Endpoint</span> <span style="color:#ff79c6">=</span> my.ddns.example.com:51820
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">AllowedIPs</span> <span style="color:#ff79c6">=</span> 0.0.0.0/0, ::/0
</span></span></code></pre></td></tr></table>
</div>
</div><p>bar client</p>
<pre tabindex="0"><code>
[Interface]
Address = 10.200.200.3/32
MTU = 1420
PrivateKey = PEER_BAR_PRIVATE_KEY
DNS = 10.200.200.1

[Peer]
PublicKey = SERVER_PUBLICKEY
PresharedKey = PRE-SHARED KEY
Endpoint = my.ddns.example.com:51820
AllowedIPs = 0.0.0.0/0, ::/0
</code></pre><p>使用 AllowedIPs = 0.0.0.0,::/0, 在VPN上转发所有ipv4 ipv6流量</p>


    </div></body>

</html>